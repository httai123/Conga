WITH C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986977 AS (
    SELECT msisdn, cal_internet_television_count_sms_received_weekly AS cal_internet_television_count_sms_received_weekly 
FROM C360_FLAT_SERVICES 
WHERE PARTITION_DATE >= LEAST(DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Monday'), '%x%v %W') - INTERVAL 3 WEEK, '%Y%m%d'), DATE_FORMAT(CURDATE() - INTERVAL 1 DAY, '%Y%m%d')) 
      AND PARTITION_DATE <= LEAST(DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') , '%Y%m%d'), DATE_FORMAT(CURDATE() - INTERVAL 1 DAY, '%Y%m%d')) 
      AND PARTITION_DATE IN (
    LEAST(DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') , '%Y%m%d'), DATE_FORMAT(CURDATE() - INTERVAL 1 DAY, '%Y%m%d')),
	DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') - INTERVAL 1 WEEK, '%Y%m%d'),
	DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') - INTERVAL 2 WEEK, '%Y%m%d'),
	DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') - INTERVAL 3 WEEK, '%Y%m%d')
)
), C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986978 AS (
    SELECT msisdn, cal_internet_television_count_all_interactive_weekly AS cal_internet_television_count_all_interactive_weekly 
FROM C360_FLAT_SERVICES 
WHERE PARTITION_DATE >= LEAST(DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Monday'), '%x%v %W') - INTERVAL 3 WEEK, '%Y%m%d'), DATE_FORMAT(CURDATE() - INTERVAL 1 DAY, '%Y%m%d')) 
      AND PARTITION_DATE <= LEAST(DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') , '%Y%m%d'), DATE_FORMAT(CURDATE() - INTERVAL 1 DAY, '%Y%m%d')) 
      AND PARTITION_DATE IN (
    LEAST(DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') , '%Y%m%d'), DATE_FORMAT(CURDATE() - INTERVAL 1 DAY, '%Y%m%d')),
	DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') - INTERVAL 1 WEEK, '%Y%m%d'),
	DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') - INTERVAL 2 WEEK, '%Y%m%d'),
	DATE_FORMAT(STR_TO_DATE(CONCAT(YEARWEEK(CURDATE()), ' Sunday'), '%x%v %W') - INTERVAL 3 WEEK, '%Y%m%d')
)
), id_1746494986979 AS (
    SELECT C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986977.msisdn AS msisdn 
FROM C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986977  
WHERE (C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986977.cal_internet_television_count_sms_received_weekly < 4) 
GROUP BY C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986977.msisdn 
HAVING COUNT(*) >= 1
), id_1746494986980 AS (
    SELECT C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986978.msisdn AS msisdn 
FROM C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986978  
WHERE (C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986978.cal_internet_television_count_all_interactive_weekly >= 10) 
GROUP BY C360_FLAT_SERVICES_EXISTS_WEEKLY_RELA_neg_3_0_id_1746494986978.msisdn 
HAVING COUNT(*) >= 1
) 
SELECT msisdn FROM (
	SELECT msisdn FROM id_1746494986979
	INTERSECT
	SELECT msisdn FROM id_1746494986980) AS t